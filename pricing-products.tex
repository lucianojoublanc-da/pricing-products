%        File: pricing-products.tex
%     Created: Mon Jul 05 11:00 am 2021 C
% Last Change: Mon Jul 05 11:00 am 2021 C
%
\documentclass[a4paper]{article}
\usepackage[]{amsmath, amssymb}
\begin{document}

\section*{Exercise}
For the following products:

\begin{itemize}
\item fixed rate, coupon paying bond
\item interest rate swap pay fixed / receive floating
\end{itemize}

Perform the following exercises:

\section{Write down the Eber/Jones expression}

Use this definition:

\begin{align*}
Claim := & Zero \\
|& One \\
|& Give \; Claim \\
|& Scale \; Observable \; Claim \\
|& And \; Claim \; Claim \\
|& Or \; Claim \; Claim \\
|& Cond \; Inequality \; Claim \; Claim \\
|& When \; Inequality \; Cliam \\
|& Anytime \; Inequality \; Claim \\
|& Until \; Inequality \; Claim \\
Inequality := & TimeGte \; t \\
| & Lte \; Observable \; Observable \\
\end{align*}
I've included the below for completeness, but you can ignore this and just write down $Observe$ as $S_t$ and $Const$ as e.g. $K$, and the operators as $+, -, \times$.
\begin{align*}
Observable := & Const \\
| & Observe \\
| & Add \; Observable \; Observable \\
| & Neg \; Observable \\
| & Mul \; Observable \; Observable
\end{align*}


For example, for a European put option:

\begin{align*}
  t &:= \text{ time to maturity} \\
  K &:= \text{ strike price} \\
  S_t &:= \text{ the (observed) stock price, follows GBM} \\
  Q_t & := \text{ the USD discount rate } \\
  & When (TimeGte \; T) (Or (Scale (K - S_t) (One Q_t)) Zero)
\end{align*}


Assume we are pricing in USD.

Check that this matches with what is produced by our implementation in https://github.com/digital-asset/contingent-claims

\section{Transform to expectations using E1-E10}

For example, the above would translate (co)recursively to

\begin{align*}
& When \quad (TimeGte \; T) \quad (Or \; (Scale \: (K - S_t) \: (One Q_t)) \; Zero) \\
= & Q_t \mathbb{E}^Q[ \frac{ Or \; (Scale \: (K - S_{t = T}) \: (One Q_{t = T})) \; Zero } { Q_T } | \mathcal{F}_t ] & \text{ by E8} \\
= & Q_t \mathbb{E}^Q[ \frac{ max ( Scale \: (K - S_T) \: (One Q_T) , Zero ) } { Q_T } | \mathcal{F}_t ] & \text{ by E6} \\
& \text{ by definition of $max$, and assuming no correlation to $Zero$, } \\
= & Q_t \mathbb{E}^Q[ \frac{  A \times I_A  + Zero \times I_{A^c}} { Q_T } | \mathcal{F}_t ] , & \{ A : Scale \: (K - S_T) \: (One Q_T) \geq Zero \} \\
= & Q_t \mathbb{E}^Q[ \frac{  A \times I_A } { Q_T } | \mathcal{F}_t ] , & \{ A : (K - S_T) \times 1 \geq 0 \} \text{ by E1, E2, E4} \\
= & Q_t \mathbb{E}^Q[ \frac{  (K - S_T) I_{K \geq S_T} } { Q_T } | \mathcal{F}_t ] \\
\end{align*}

Note that here I've \emph{not} written everything in terms of filtered expectations. I'm not sure anymore if this is helpful - I think that it's enough to observe that the tower property applies to nested $When$ expressions; also, you established that $Until$ in it's current form is not an expectation. 

Also note that I've now expaned this co-recursively (i.e. from the outside in / top to bottom) rather than recursively (inside-out / leaves-to-root). This is so the assignment of $T$ is clear.

\section{Simplify the expectation to an analytical price}

This is where you would use 'change of numeraire' if necessary - in this example it's not.

\begin{align*}
& Q_t \mathbb{E}^Q[ \frac{  (K - S_T) I_{K \geq S_T} } { Q_T } | \mathcal{F}_t ] \\
= & Q_t \mathbb{E}^Q[ \frac{K} {Q_T} I_{K \geq S_T} | \mathcal{F}_t ] - Q_t \mathbb{E}^Q[ \frac{S_T} {Q_T} I_{K \geq S_T} | \mathcal{F}_t ] \\
& \text{quotient in the RHS is a Radom-Nykodim derivative, so by FAPF $\frac{S_t}{Q_t} = E^Q[\frac{S_T}{Q_T} | F_t]$} \\
& \text{and for LHS term, let's assume $Q(t)$ is deterministic, then} \\
= & \frac{Q^t} {Q_T} K \mathbb{E}^Q[  I_{K \geq S_T} | \mathcal{F}_t ] - \frac{Q_t}{Q_t} S_t \mathbb{E}^{*}[  I_{K \geq S^*_T} | \mathcal{F}_t ] \\
= & K e^{-r(T-t)} \mathbb{P}^Q[K \geq S_T] - S_t \mathbb{P}^{*}[K \geq S^*_T] \\
\end{align*}

With some more working, and taking care to use the appropriate measure $Q$ or $*$, this reduces to the Black formula.

\section{Verify your results by numerical approximation (or otherwise)}

\end{document}
